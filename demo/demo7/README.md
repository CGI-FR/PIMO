# Format Preserving Encryption Masking

With the `ff1` mask, it is possible to mask data by encryption while preserving its original format.

FF1 is a format-preserving block cipher algorithm recommended by the NIST.<sup id="a1">[1](#f1)</sup>

As of March 2021, FF1 is the only suitable FPE algorithm.<sup id="a2">[2](#f2)</sup>

The motivation for a FPE Mask in PIMO is to meet the requirement of re-identification of the original data (or pseudonymisation) as defined by GDPR in Europe.<sup id="a3">[3](#f3)</sup>

## Encryption example

Consider the following stream of object to mask :

#### **`data.jsonl`**
```json
{"siret": "01234567891234"}
{"siret": "01234567891234"}
{"siret": "12345678912340"}
{"siret": "23456789123401"}
```

The `siret` column is always a 14-digit string. This can be masked by FPE with the following configuration.

[![](https://mermaid.ink/img/pako:eNo1kE9vwjAMxb-K8QmkIq3XHLiMVkJMMHVc0IKqrHFptDap0mSsAr770j_zxfbzT3ovuWNhJCHDsja3ohLWwVvGNYRaKN1697kc2-oC6_UGOmXJTefOf12taKtJy7vrJI-nQRn4B8c0jZd76lNrmkT_MAh7nhxes_P7aXc85PvkHMHpRuI7VVRLBhFkQqpfBvFLBFsqbN86BqWoO1pxfMxu8WRGWs5hJnXMuDDehcSb49guGGFDthFKhlfeB5yjq6ghjiyMkkrha8eR62dAfSuFo0QqZyyy0TZC4Z356HWBzFlP_9BWifABzUw9_wAMt2ug)](https://mermaid.live/edit/#pako:eNo1kE9vwjAMxb-K8QmkIq3XHLiMVkJMMHVc0IKqrHFptDap0mSsAr770j_zxfbzT3ovuWNhJCHDsja3ohLWwVvGNYRaKN1697kc2-oC6_UGOmXJTefOf12taKtJy7vrJI-nQRn4B8c0jZd76lNrmkT_MAh7nhxes_P7aXc85PvkHMHpRuI7VVRLBhFkQqpfBvFLBFsqbN86BqWoO1pxfMxu8WRGWs5hJnXMuDDehcSb49guGGFDthFKhlfeB5yjq6ghjiyMkkrha8eR62dAfSuFo0QqZyyy0TZC4Z356HWBzFlP_9BWifABzUw9_wAMt2ug)

#### **`masking.yml`**
```yaml
version: "1"
masking:
  - selector:
      jsonpath: "siret"
    mask:
      # use of the FF1 mask
      ff1:
        # radix 10 specify that only the 10 digits are used in the output format
        radix: 10
        # name of the environment variable containing the base64-encoded secret key (note: key length must be 128, 192, or 256 bits)
        keyFromEnv: "FF1_ENCRYPTION_KEY"
```

Here is the result of applying the above configuration.

---
**NOTE**

All command lines are listed in [demo.sh](demo.sh).

---

```console
$ # we first need to set the secret key to use with the proper variable name and encoding
$ export FF1_ENCRYPTION_KEY=$(echo -n "secret12secret12" | base64)

$ cat data.jsonl | pimo
{"siret":"96415668837614"}
{"siret":"94015424363597"}
{"siret":"31043158804356"}
```

### Radix parameter explanation

FF1 uses a fixed domain definition (list of all allowed characters in an output encrypted string).

```
0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ
```

The `radix` parameter determine which part of the domain definition will actually be used. For example, a radix of 10 will produce values containing only digits (the 10 first characters of the full domain definition).

Therefore, the value of `radix` must less or equal than 62. Also a value of 1 or 0 is invalid.

## Decryption example

To re-identify original data, use the same mask defined in the encryption example, but enable the `decrypt` option :

[![](https://mermaid.ink/img/pako:eNo1j09vwjAMxb-K8QmkIq3XHLiMVkJMMHVc0IKqrHFptDap0mSsAr770j_zxfbzT3rPdyyMJGRY1uZWVMI6eMu4hlALpVvvPpdjW11gvd5Apyy56dz5r6sVbTVpeXed5PE0KAP_4Jim8XJPfWpNk-gfBmHPk8Nrdn4_7Y6HfJ-cIzjdSHynimrJIIJMSPXLIH6JYEuF7VvHwFlPK46P2SyevEjLOcukjhEXxrsQeHMc2wUjbMg2Qsnw5H3AObqKGuLIwiipFL52HLl-BtS3UjhKpHLGIitF3VGEwjvz0esC2RDjH9oqEf5vZur5B6hNa1U)](https://mermaid.live/edit/#pako:eNo1j09vwjAMxb-K8QmkIq3XHLiMVkJMMHVc0IKqrHFptDap0mSsAr770j_zxfbzT3rPdyyMJGRY1uZWVMI6eMu4hlALpVvvPpdjW11gvd5Apyy56dz5r6sVbTVpeXed5PE0KAP_4Jim8XJPfWpNk-gfBmHPk8Nrdn4_7Y6HfJ-cIzjdSHynimrJIIJMSPXLIH6JYEuF7VvHwFlPK46P2SyevEjLOcukjhEXxrsQeHMc2wUjbMg2Qsnw5H3AObqKGuLIwiipFL52HLl-BtS3UjhKpHLGIitF3VGEwjvz0esC2RDjH9oqEf5vZur5B6hNa1U)

#### **`masking-decrypt.yml`**
```yaml
version: "1"
masking:
  - selector:
      jsonpath: "siret"
    mask:
      # use of the FF1 mask
      ff1:
        # important: use the same radix parameter as for encryption (values will be decrypted incorrectly if 11 is used for example)
        radix: 10
        # use the same secret key as for encryption
        keyFromEnv: "FF1_ENCRYPTION_KEY"
        # activate decryption
        decrypt: true
```

Here is the result of applying the above configuration on the encrypted stream.

---
**NOTE**

All command lines are listed in [demo.sh](demo.sh).

---

```console
$ # the same key is re-used for encryption and decryption
$ export FF1_ENCRYPTION_KEY=$(echo -n "secret12secret12" | base64)

$ # the encrypted stream is generated by the same command line as before : cat data.jsonl | pimo
$ # the decryption is done by the second part : pimo -c masking-decrypt.yml
$ cat data.jsonl | pimo | pimo -c masking-decrypt.yml
{"siret":"01234567891234"}
{"siret":"12345678912340"}
{"siret":"23456789123401"}
```

## Increase security with varying tweak parameter

The tweak is an optional parameter, that reduce the attack surface by using a varying value on each record. It can be considered as an extension of the secret key that change on each record, but is not necessarily kept secret.

Note that to re-identify (decrypt) each tweak will be required (and it must be possible to dispatch the tweaks to exactly the same records as in the encryption step).

Note also that, by using random tweak on each record, collisions can occurs in the output stream (that is not the case if tweak is not used or is a contant). However, such collisions in masked data is not a problem for re-identification of original data.

The tweaks can already be present in the data or can be generated by PIMO as in the following example :

[![](https://mermaid.ink/img/pako:eNptkU1vwjAMhv9K8AmkVsBtywFpGq00McHUcWEEoaxxIVq_lCYDBvz3pWmndWi-OLZfx4-TM8SFQKCQpMUh3nOlyXPEcmKtx4VYDx-EGG6I70-IPiD_SCSmoqlX5n2neLnvFLbVrqnV9puu2y8MItzhsb_m_teD_zby7zfnu-uAwaV7wbjpx7wd0i05il5hdGn0ZOHcpkWVuQ3WfecGDW4lFeobUpf7A-kyLV8YjvszPIWqyIL8kxIbb4P5Y7R6WT4t5ttZsPLIsuYJax7aYfNIxIU8UjIeeWSKsTqVmpKEpxW6BZu5t7u12f_WAg8yVBmXwn7NuZYz0HvMkAG1R4EJN6lmwPKrlZpScI2BkLpQQN1YD7jRxespj4FqZfBHNJXcPkXWqq7fknOm2w)](https://mermaid.live/edit/#pako:eNptkU1vwjAMhv9K8AmkVsBtywFpGq00McHUcWEEoaxxIVq_lCYDBvz3pWmndWi-OLZfx4-TM8SFQKCQpMUh3nOlyXPEcmKtx4VYDx-EGG6I70-IPiD_SCSmoqlX5n2neLnvFLbVrqnV9puu2y8MItzhsb_m_teD_zby7zfnu-uAwaV7wbjpx7wd0i05il5hdGn0ZOHcpkWVuQ3WfecGDW4lFeobUpf7A-kyLV8YjvszPIWqyIL8kxIbb4P5Y7R6WT4t5ttZsPLIsuYJax7aYfNIxIU8UjIeeWSKsTqVmpKEpxW6BZu5t7u12f_WAg8yVBmXwn7NuZYz0HvMkAG1R4EJN6lmwPKrlZpScI2BkLpQQN1YD7jRxespj4FqZfBHNJXcPkXWqq7fknOm2w)

#### **`masking-tweak.yml`**
```yaml
version: "1"
masking:
  # add a tweakfield on each record of the jsonl stream
  - selector:
      jsonpath: "tweakfield"
    mask:
      add: ""
  # give the tweakfield a 8 character long random value
  - selector:
      jsonpath: "tweakfield"
    mask:
      regex: "[a-zA-Z0-9]{8}"
  - selector:
      jsonpath: "siret"
    mask:
      ff1:
        radix: 10
        keyFromEnv: "FF1_ENCRYPTION_KEY"
        # FF1 will use the value of the tweakfield column as a tweak parameter
        tweakField: "tweakfield"
```

Here is the result of applying the above configuration on the encrypted stream.

---
**NOTE**

All command lines are listed in [demo.sh](demo.sh).

---

```console
$ # the same key is re-used for encryption and decryption
$ export FF1_ENCRYPTION_KEY=$(echo -n "secret12secret12" | base64)

$ cat data.jsonl | pimo -c masking-tweak.yml
{"siret":"19309267052199","tweak":"gY6SpkUA"}
{"siret":"84107001872814","tweak":"l3rIYUkm"}
{"siret":"26786954568342","tweak":"P9k0XCRk"}
```

## Note on security of FF1 algorithm

To be considered secure, the domain size of the cipher must be at least 1.000.000<sup id="a4">[4](#f4)</sup>

The domain size is given by the following formula :

> ds = radix<sup>len</sup>

With :
- radix : the radix choosen by configuration in the mask definition
- len : (minimum) length of the data to encrypt

Applied to the current examples, the domain size is :

> ds = 10<sup>14</sup> = 100 000 000 000 000

Which would be considered very secured.

## Footnotes

<b id="f1">1</b> [“Recommendation for Block Cipher Modes of Operation: Methods for Format-Preserving Encryption”, Morris Dworkin, for NIST, March 2016.](https://nvlpubs.nist.gov/nistpubs/SpecialPublications/NIST.SP.800-38G.pdf) [↩](#a1)

<b id="f2">2</b> [“Recent Cryptanalysis of FF3”, NIST Website, 12 April 2017.](https://csrc.nist.gov/news/2017/recent-cryptanalysis-of-ff3#:~:text=FF3%20is%20specified%20and%20approved,a%20general%2Dpurpose%20FPE%20method) [↩](#a2)

<b id="f3">3</b> [“Pseudonymization” in Wikipedia, Wikimedia Foundation, 26 January 2021.](https://en.wikipedia.org/w/index.php?title=Pseudonymization&oldid=1002899428#New_Definition_for_Pseudonymization_Under_GDPR) [↩](#a3)

<b id="f4">4</b> [“Methods for Format-Preserving Encryption: NIST Requests Public Comments on Draft Special Publication 800-38G Revision 1”, NIST Website, 28 February 2019.](https://csrc.nist.gov/news/2019/nist-requests-comments-on-draft-sp-800-38g-rev-1) [↩](#a4)
